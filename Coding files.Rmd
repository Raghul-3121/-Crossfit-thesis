---
title: "CrossFit Gym Attendance Analysis"
author: "Raghul Senthilvel"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_notebook
---

```{r}
# ---- Libraries ----
library(tidyverse)
library(lubridate)
library(cluster)
library(factoextra)
library(ggplot2)
library(viridis)
library(tidyr)
library(forcats)
set.seed(123)

```


```{r}
# ---- Data Cleaning ----
df <- read_csv("Data ranges 23 to 25.csv", locale = locale(encoding = "UTF-8"))
df_clean <- df %>%
  mutate(`Start Datetime` = ymd_hms(`Start Datetime`, quiet = TRUE),
         Date = as.Date(`Start Datetime`)) %>%
  select(`Client ID`, Date, Location, Status, `Membership Type`) %>%
  drop_na() %>%
  filter(Location != "Bua Dunleer")

```


```{r}
# ---- Figure: Weekly Attendance Pattern by Day of Week ----
df_clean <- df_clean %>%
  mutate(day_of_week = wday(Date, label = TRUE, abbr = TRUE, week_start = 1))

attendance_dow <- df_clean %>%
  group_by(Location, day_of_week) %>%
  summarise(Attendances = n(), .groups = "drop")

ggplot(attendance_dow, aes(day_of_week, Attendances, fill = Location)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = Attendances), vjust = -0.5, size = 3) +
  facet_wrap(~ Location, scales = "free_y") +
  labs(title = "Weekly Attendance by Day of Week", x = "Day", y = "Attendance") +
  theme_minimal()

```


```{r}
# Find first active date per client-location
first_active <- df_clean %>%
  group_by(`Client ID`, Location) %>%
  summarise(first_active = floor_date(min(Date), "month"), .groups = "drop")

# Count number of new joiners per month and location
first_active_counts <- first_active %>%
  count(Location, first_active)

# Drop the very first month (system onboarding spike)
min_month <- min(first_active_counts$first_active)
first_active_counts <- first_active_counts %>%
  filter(first_active > min_month)

# Plot
ggplot(first_active_counts, aes(first_active, n, fill = Location)) +
  geom_col() +
  facet_wrap(~ Location, scales = "free_y") +
  labs(title = "New Clients per Month", x = "Month", y = "Count") +
  theme_minimal()

```


```{r}
# Find last active date per client-location
last_active <- df_clean %>%
  group_by(`Client ID`, Location) %>%
  summarise(last_active = floor_date(max(Date), "month"), .groups = "drop")

# Count number of drop-offs per month and location
last_active_counts <- last_active %>%
  count(Location, last_active)

# Drop the very last month (spurious spike from extraction)
max_month <- max(last_active_counts$last_active)
last_active_counts <- last_active_counts %>%
  filter(last_active < max_month)

# Plot
ggplot(last_active_counts, aes(last_active, n, fill = Location)) +
  geom_col() +
  facet_wrap(~ Location, scales = "free_y") +
  labs(title = "Dropoffs per Month", x = "Month", y = "Count") +
  theme_minimal()

```


```{r}
# ---- Build Weekly Matrix for Clustering ----
weekly_attendance <- df_clean %>%
  mutate(week = floor_date(Date, "week")) %>%
  group_by(`Client ID`, week) %>%
  summarise(weekly_visits = n(), .groups = "drop")

all_weeks <- tibble(week = seq.Date(min(weekly_attendance$week), max(weekly_attendance$week), by = "week"))
clients <- weekly_attendance %>% distinct(`Client ID`)
full_grid <- crossing(`Client ID` = clients$`Client ID`, week = all_weeks$week)

weekly_full <- full_grid %>%
  left_join(weekly_attendance, by = c("Client ID", "week")) %>%
  mutate(weekly_visits = replace_na(weekly_visits, 0))

client_weekly_matrix <- weekly_full %>%
  pivot_wider(names_from = week, values_from = weekly_visits, values_fill = 0)

attendance_matrix <- as.matrix(client_weekly_matrix %>% select(-`Client ID`))
attendance_matrix_scaled <- scale(attendance_matrix)

```


```{r}
# ---- Figure 4: Elbow Plot for K-Means Clustering ----
wss <- sapply(1:10, function(k){
  kmeans(attendance_matrix_scaled, centers = k, nstart = 20)$tot.withinss
})
elbow_df <- data.frame(k = 1:10, wss = wss)
ggplot(elbow_df, aes(x = k, y = wss)) +
  geom_line(color = "black", size = 1) +
  geom_point(color = "black", size = 2) +
  labs(title = "Elbow Plot for K-means Clustering",
       x = "Number of Clusters (K)", y = "Total Within-Cluster Sum of Squares") +
  theme_minimal()

```


```{r}
# ---- Figure 5: Silhouette Plot for K-Means Clustering ----
kmeans_result <- kmeans(attendance_matrix_scaled, centers = 3, nstart = 50)
client_weekly_clustered <- client_weekly_matrix %>%
  mutate(Cluster = factor(kmeans_result$cluster))
sil <- silhouette(as.numeric(client_weekly_clustered$Cluster), dist(attendance_matrix_scaled))
fviz_silhouette(sil)
```


```{r}
# ---- Figure 6: PCA Plot of Clients Coloured by Cluster ----
pca <- prcomp(attendance_matrix_scaled)
pca_df <- data.frame(pca$x[,1:2], 
                     Cluster = client_weekly_clustered$Cluster, 
                     ClientID = client_weekly_clustered$`Client ID`)
ggplot(pca_df, aes(PC1, PC2, color = Cluster)) + 
  geom_point(alpha = 0.7) + 
  theme_minimal() +
  labs(title = "PCA of Clients Colored by Cluster")

```


```{r}
# ---- Client Metrics, Cluster Remapping, and A2.1 Table ----
client_metrics <- weekly_full %>%
  group_by(`Client ID`) %>%
  summarise(mean_visits = mean(weekly_visits),
            sd_visits = sd(weekly_visits),
            presence_ratio = mean(weekly_visits > 0),
            ICV = ifelse(sd_visits == 0, mean_visits + 0.01, mean_visits / sd_visits),
            .groups = "drop") %>%
  left_join(client_weekly_clustered %>% select(`Client ID`, Cluster), by = "Client ID")

client_metrics <- client_metrics %>% mutate(Cluster_orig = as.character(Cluster))
attendance_order <- client_metrics %>%
  group_by(Cluster_orig) %>%
  summarise(mean_attendance = mean(mean_visits, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(mean_attendance)) %>%
  mutate(Cluster_remap = as.character(row_number()))
client_metrics <- client_metrics %>%
  left_join(attendance_order %>% select(Cluster_orig, Cluster_remap), by = "Cluster_orig") %>%
  mutate(Cluster = Cluster_remap)

client_weekly_clustered <- client_weekly_clustered %>%
  mutate(Cluster_orig = as.character(Cluster)) %>%
  left_join(attendance_order %>% select(Cluster_orig, Cluster_remap), by = "Cluster_orig") %>%
  mutate(Cluster = Cluster_remap)

# ---- A2.1 Cluster-wise Summary Table ----
cluster_summary <- client_metrics %>%
  group_by(Cluster) %>%
  summarise(
    N = n(),
    mean_mean_visits = mean(mean_visits),
    mean_ICV = mean(ICV),
    mean_presence_ratio = mean(presence_ratio)
  )
cluster_summary

```


```{r}
# ---- Figure 7: Cluster-wise Weekly Attendance Trend ----
cluster_weekly <- weekly_full %>%
  left_join(client_weekly_clustered %>% select(`Client ID`, Cluster), by = "Client ID")

cluster_week_trends <- cluster_weekly %>%
  group_by(Cluster, week) %>%
  summarise(avg_visits = mean(weekly_visits), .groups = "drop")

ggplot(cluster_week_trends, aes(x = week, y = avg_visits, color = Cluster, group = Cluster)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 1.5) +
  labs(
    title = "Figure 7: Cluster-wise Weekly Attendance Trend",
    x = "Week", y = "Average Weekly Visits", color = "Cluster"
  ) +
  theme_minimal(base_size = 14) +
  scale_color_manual(values = c("1" = "tomato", "2" = "forestgreen", "3" = "steelblue")) +
  theme(legend.position = "right", plot.title = element_text(hjust = 0.5))

```


```{r}
# ---- Figure 8: ICV Density by Cluster ----
cluster_means <- client_metrics %>%
  group_by(Cluster) %>%
  summarise(mean_ICV = mean(ICV, na.rm = TRUE), .groups = "drop")

ggplot(client_metrics, aes(x = ICV, fill = Cluster, color = Cluster)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  geom_vline(data = cluster_means,
             aes(xintercept = mean_ICV, color = Cluster),
             linetype = "dashed", linewidth = 1) +
  scale_fill_manual(values = c("1" = "tomato", "2" = "forestgreen", "3" = "steelblue")) +
  scale_color_manual(values = c("1" = "tomato", "2" = "forestgreen", "3" = "steelblue")) +
  labs(
    title = "Figure 8: Inverse Coefficient of Variation (ICV) Density by Cluster",
    x = "Inverse Coefficient of Variation (ICV = μ / σ)",
    y = "Density of ICV Scores",
    fill = "Cluster",
    color = "Cluster"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "right", plot.title = element_text(hjust = 0.5))

```


```{r}
# ---- Figure 9: Top 5 LVHC Clients per Gym ----
weekly_full_with_location <- df_clean %>%
  mutate(week = floor_date(Date, "week")) %>%
  group_by(`Client ID`, Location, week) %>%
  summarise(visits = n(), .groups = "drop")

clients_locations <- weekly_full_with_location %>% distinct(`Client ID`, Location)
full_grid_location <- crossing(`Client ID` = clients_locations$`Client ID`, 
                              Location = clients_locations$Location, 
                              week = all_weeks$week)

weekly_full_location <- full_grid_location %>%
  left_join(weekly_full_with_location, by = c("Client ID", "Location", "week")) %>%
  mutate(visits = replace_na(visits, 0))

# LVHC criteria
lvhc_clients <- client_metrics %>%
  filter(mean_visits <= 2, ICV >= 1, presence_ratio >= 0.7)

lvhc_clients_visits <- weekly_full_with_location %>%
  filter(`Client ID` %in% lvhc_clients$`Client ID`) %>%
  group_by(`Client ID`, Location) %>%
  summarise(total_visits = sum(visits), .groups = "drop")

top5_per_location_visits <- lvhc_clients_visits %>%
  group_by(Location) %>%
  arrange(desc(total_visits)) %>%
  slice_head(n = 5) %>%
  ungroup() %>%
  mutate(`Client ID` = as.character(`Client ID`),
         `Client ID` = fct_reorder(`Client ID`, total_visits))

ggplot(top5_per_location_visits, aes(x = total_visits, y = `Client ID`)) +
  geom_col(fill = "#4a90e2", width = 0.7) +
  facet_wrap(~ Location, nrow = 2, ncol = 2, scales = "free_y",
             labeller = labeller(Location = function(x) paste("Top 5 LVHC Clients (", x, ")", sep = ""))) +
  labs(
    x = "Total Visits", y = "Client ID"
  ) +
  theme_minimal(base_size = 13) +
  theme(strip.text = element_text(size = 12, face = "bold"),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10))

```


```{r}
# Step 1: Weekly aggregation WITH location (omit Dunleer)
df_weekly <- df_clean %>%
  filter(Location != "Bua Dunleer") %>%
  mutate(week = floor_date(Date, "week")) %>%
  group_by(`Client ID`, Location, week) %>%
  summarise(visits = n(), .groups = "drop")

# Step 2: Full timeline for all clients in all gyms
all_weeks <- tibble(week = seq.Date(from = min(df_weekly$week),
                                    to = max(df_weekly$week),
                                    by = "week"))
clients_locs <- df_weekly %>% distinct(`Client ID`, Location)
full_timeline <- crossing(`Client ID` = clients_locs$`Client ID`,
                          Location = clients_locs$Location,
                          week = all_weeks$week)

weekly_full <- full_timeline %>%
  left_join(df_weekly, by = c("Client ID", "Location", "week")) %>%
  mutate(visits = replace_na(visits, 0))

# Step 3: Calculate metrics PER CLIENT PER GYM
consistency_metrics <- weekly_full %>%
  group_by(`Client ID`, Location) %>%
  summarise(
    weeks_present = sum(visits > 0),
    total_weeks = n(),
    presence_ratio = weeks_present / total_weeks,
    mean_visits = mean(visits),
    sd_visits = sd(visits),
    cv_visits = ifelse(mean_visits == 0, NA, sd_visits / mean_visits),
    .groups = "drop"
  )

# Step 4: Filter for LVHC clients per gym
lvhc_clients <- consistency_metrics %>%
  filter(mean_visits <= 2.0,
         cv_visits <= 1.0,
         presence_ratio >= 0.7) %>%
  arrange(Location, desc(presence_ratio))

# Step 5: For each gym, pick top 3 unique LVHC clients
lvhc_top3 <- lvhc_clients %>%
  group_by(Location) %>%
  slice_max(order_by = presence_ratio, n = 3, with_ties = FALSE) %>%
  ungroup()

# Step 6: Prep for heatmap
heatmap_data <- weekly_full %>%
  semi_join(lvhc_top3, by = c("Client ID", "Location")) %>%
  mutate(label = paste0(`Client ID`, " (", Location, ")"))

# Set levels for ordered y-axis
heatmap_data$label <- factor(heatmap_data$label,
                             levels = unique(heatmap_data$label[order(heatmap_data$Location, heatmap_data$`Client ID`)]))

# Step 7: Plot visually appealing heatmap
ggplot(heatmap_data, aes(x = week, y = label, fill = visits)) +
  geom_tile() +
  scale_fill_viridis(
    name = "Visits/Week",
    option = "plasma",
    limits = c(0, 5),
    breaks = 0:5,
    labels = c("0 (Missed)", "1", "2", "3", "4", "5+")
  ) +
  labs(
    x = "Week",
    y = "Client ID (Location)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.y = element_text(size = 10, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5)
  )
```


```{r}
# ---- Table 1: LVHC Clients at Risk of Churn & A2.2 Table ----
lvhc_churn <- weekly_full_location %>%
  filter(`Client ID` %in% lvhc_clients$`Client ID`, visits > 0) %>%
  group_by(`Client ID`) %>%
  summarise(last_attended = max(week), .groups = "drop") %>%
  mutate(weeks_since = as.numeric(difftime(as.Date("2025-03-31"), last_attended, units = "weeks"))) %>%
  filter(weeks_since >= 4)

# A2.2 Table: LVHC Churn Identification
lvhc_churn

```


```{r}
# ---- Figure 11: Drop-Off Patterns in LVHC Attendance ----
if(nrow(lvhc_churn) > 0) {
  lvhc_churn_ids <- lvhc_churn$`Client ID`
  churn_traj <- weekly_full_location %>%
    filter(`Client ID` %in% lvhc_churn_ids) %>%
    left_join(lvhc_churn %>% select(`Client ID`, last_attended), by = "Client ID") %>%
    mutate(period = ifelse(week > last_attended, "Post-Churn", "Pre-Churn"))
  lvhc_churn_ids_head <- head(unique(churn_traj$`Client ID`), 4)
  ggplot(churn_traj %>% filter(`Client ID` %in% lvhc_churn_ids_head), 
         aes(week, visits, color = period)) +
    geom_line(linewidth = 1) +
    facet_wrap(~ `Client ID`) +
    scale_color_manual(values = c("Pre-Churn" = "steelblue", "Post-Churn" = "red")) +
    labs(title = "Attendance Trajectories of Churned LVHC Clients", 
         x = "Week", y = "Visits", color = "Period") +
    theme_minimal()
} else {
  print("No LVHC clients identified as churned.")
}

```

